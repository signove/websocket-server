/*! Micro-Service-HUB-JS-library 2022-05-14 */
class MicroServiceHUB{constructor(){this.mSessionKey=void 0,this.mClientKey=void 0,this.mWebSocketRTObject=void 0,this.mWebSocketConfigObject=void 0}connect(n,i,o){return this.mWebSocketRTObject?this.disconnect().then(()=>this.connect(n,i,o)):(this.mWebSocketRTObject=new WebSocket(n+"?session="+encodeURIComponent(i)+"&client="+encodeURIComponent(o)),this.mWebSocketRTObject.binaryType="arraybuffer"),this.secretConfigKey=void 0,new Promise((s,t)=>{this.mWebSocketRTObject.onopen=e=>{this.mSessionKey=i,this.mClientKey=o},this.mWebSocketRTObject.onmessage=e=>{var t,i,o;e.data instanceof ArrayBuffer?({version:t,sender:i,payload:o}=Utils.readMicroServiceHUBMessage(e.data),this.secretConfigKey=Utils.arrayBufferToString(o)):this.secretConfigKey=e.data,this.mWebSocketConfigObject=new WebSocket(n+"/config?secret_config_key="+encodeURIComponent(this.secretConfigKey)+"&session="+encodeURIComponent(this.mSessionKey)+"&client="+encodeURIComponent(this.mClientKey)),this.mWebSocketConfigObject.binaryType="arraybuffer",this.mWebSocketConfigObject.onopen=e=>{s({sessionKey:this.mSessionKey,myKey:this.mClientKey})},this.mWebSocketConfigObject.onerror=e=>{this.mWebSocketConfigObject=void 0},this.mWebSocketConfigObject.onmessage=e=>{var t,i,o,s="";s=e.data instanceof ArrayBuffer?({version:t,sender:i,payload:o}=Utils.readMicroServiceHUBMessage(e.data),o):e.data,document.dispatchEvent(new CustomEvent("microservicehub.config.message",{detail:{version:t,sender:i,message:s}}))},this.mWebSocketRTObject.onmessage=e=>{var t,i,o;e.data instanceof ArrayBuffer?{version:t,sender:i,payload:o}=Utils.readMicroServiceHUBMessage(e.data):e.data,document.dispatchEvent(new CustomEvent("microservicehub.message",{detail:{version:t,sender:i,message:o}}))}},this.mWebSocketRTObject.onerror=e=>{this.mSessionKey=void 0,this.mClientKey=void 0,this.mWebSocketConfigObject=void 0,t(e)}})}disconnect(){this.mWebSocketRTObject&&this.mWebSocketRTObject.close(),this.mWebSocketConfigObject&&this.mWebSocketConfigObject.close();var e=new Promise((t,e)=>{this.mWebSocketRTObject?this.mWebSocketRTObject.onclose=e=>{this.mWebSocketRTObject=void 0,t("RT session closed")}:t("RT session not opened")}),t=new Promise((t,e)=>{this.mWebSocketConfigObject?this.mWebSocketConfigObject.onclose=e=>{this.mWebSocketConfigObject=void 0,t("Config session closed")}:t("Config session not opened")});return Promise.all([e,t])}send(e,t=""){return void 0!==this.mWebSocketRTObject&&this.mWebSocketRTObject.send(Utils.createMicroServiceHUBMessage(e,t)),new Promise((e,t)=>{void 0===this.mWebSocketRTObject?t({message:"It is not connected!"}):e()})}sendConfigMessage(e){return void 0!==this.mWebSocketConfigObject&&this.mWebSocketConfigObject.send(Utils.createMicroServiceHUBMessage(e)),new Promise((e,t)=>{void 0===this.mWebSocketConfigObject?t({message:"It is not connected!"}):e()})}}class Utils{constructor(){}static uuid(){function e(){var e=Math.pow(16,3);return(Math.random()*(Math.pow(16,4)-e)+e|0).toString(16)}return[e()+e(),e(),e(),e(),e()+e()+e()].join("-")}static execJavascript(code){eval(code)}static arrayBufferToString(e){return String.fromCharCode.apply(null,new Uint8Array(e))}static stringToArrayBuffer(e,t=e.length){for(var t=new ArrayBuffer(t),i=new Uint8Array(t),o=0,s=e.length;o<s;o++)i[o]=e.charCodeAt(o);return t}static readMicroServiceHUBMessage(e){for(var t=[],i=new DataView(e).getUint16(0),o=new DataView(e,2,20),s=0;s<o.byteLength&&0!=o.getUint8(s);s++)t[s]=String.fromCharCode(o.getUint8(s));return{version:i,sender:t.join(""),payload:e.slice(22)}}static createMicroServiceHUBMessage(e,t=""){t=t.substring(0,20);for(var i=new ArrayBuffer(22+e.byteLength),o=(new DataView(i).setUint16(0,1),new DataView(i,2,20)),s=0;s<t.length;s++)o.setUint8(s,t.charCodeAt(s));for(var n=new DataView(e),c=new DataView(i,22),s=0;s<n.byteLength;s++)c.setUint8(s,n.getUint8(s));return i}}
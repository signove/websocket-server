<html>
  <head>
    <script src="microservicehub.all.min.js"> </script>
    <script>
      var m = new MicroServiceHUB();

      function connectButton() {
        var ws_url = document.getElementById('ws_url').value;
        var session_key = document.getElementById('session_key').value;
        var client_key = document.getElementById('client_key').value;
        m.connect(ws_url, session_key, client_key)
          .then(function(evt) {
            console.log("Connected!");
            console.log(evt);
          })
          .catch(function(evt) {
            console.log("Not connected!");
            console.log(evt);
          });
      }

      function disconnectButton() {
        m.disconnect()
          .then(function(response) {
            console.log("Disconnected");
            console.log(JSON.stringify(response));
          })
          .catch(function(response) {
            console.log("Not disconnected");
            console.log(JSON.stringify(response));
          })
      }

      document.addEventListener("microservicehub.message", function(e) {
          if(e.detail.command == 0) {
            var message_log = document.getElementById('message_log');
            message_log.innerHTML += (e.detail.sender + " - " + Utils.arrayBufferToString(e.detail.message) + "\n");
          } else if(e.detail.command == 2) {
            var memory_log = document.getElementById('memory_log');
            memory_log.innerHTML += (e.detail.sender + " - " + Utils.arrayBufferToString(e.detail.message) + "\n");
          }
          
      });

      function sendMessageButton() {
        var message = document.getElementById('message').value;
        var receiver = document.getElementById('receiver').value;

        if(receiver == "") {
          receiver = undefined;
        }

        message = Utils.createMicroServiceHUBMessageV2(0, Utils.stringToArrayBuffer(document.getElementById('message').value), receiver);
        m.send(message)
          .then(function() {
              console.log("Message sent!");
          })
          .catch(function(evt) {
              alert(evt.message);
          })
      }

      function writeMemoryButton() {
        var memory = Utils.stringToArrayBuffer(document.getElementById('memory_write').value);
        var message = Utils.createMicroServiceHUBMessageV2(1, memory)
        m.send(message)
          .then(function() {
              console.log("Message sent!");
          })
          .catch(function(evt) {
              alert(evt.message);
          })
      }

      function readMemoryButton() {
        var message = Utils.createMicroServiceHUBMessageV2(2, Utils.stringToArrayBuffer(""));
        m.send(message)
          .then(function() {
              console.log("Message sent!");
          })
          .catch(function(evt) {
              alert(evt.message);
          })
      }

      function setup() {
        var ws_url_input = document.getElementById('ws_url');
        ws_url_input.value = "ws://" + window.location.host + "/websocket"
      }

      function detectEnterKeyMessage(e) {
        if (e.keyCode == 13) {
            sendMessageButton();
        }
      }

    </script>

    <style>
      input[type="text"] {
        width: 400px;
      }
      textarea {
        width: 100%;
        height: 300px;
      }

      body {
        display: flex;
        flex-flow: column wrap;
        align-content: space-around;
        border: 1px solid black;
      }

      .view_box {
        display: flex;
        flex-flow: row wrap;
        align-content: space-around;
        border: 1px solid black;
      }

      .view_box > div {
        border: 1px solid blue;
        flex: 1;
      }

    </style>
  </head>

  <body onload="setup();">
    <div class="config_box">
      <input type="text" id="ws_url" value=""><label>WebSocket URL</label>
      <br/><input type="text" id="session_key" value="s1"><label><button onclick="document.getElementById('session_key').value = Utils.uuid();">&lt; UUID</button> Session Key</label>
      <br/><input type="text" id="client_key" value="c1"><label>Client Key</label>
      <br/><button onclick="connectButton()">Connect</button>
           <button onclick="disconnectButton()">Disconnect</button>
    </div>
    <div class="view_box">
      <div>
        <input type="text" id="message" onkeyup="detectEnterKeyMessage(event)" value=""><label>Message</label>
        <input type="text" id="receiver" value=""><label>Receiver</label>
        <br/><button onclick="sendMessageButton()">Send message</button>
        <br/><textarea id="message_log"></textarea>
      </div>
    </div>
    <div>
      <input type="text" id="memory_write" value=""><label>Memory Write</label>
      <br/><button onclick="writeMemoryButton()">Write memory</button>
      <br/><button onclick="readMemoryButton()">Read memory</button>
      <br/><textarea id="memory_log"></textarea>
    </div>
  </body>
</html>

"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),MicroServiceHUB=function(){function e(){_classCallCheck(this,e),this.mSessionKey=void 0,this.mClientKey=void 0,this.mWebSocketRTObject=void 0,this.mWebSocketConfigObject=void 0}return _createClass(e,[{key:"connect",value:function(e,n,t){var o=this;return this.mWebSocketRTObject?this.disconnect().then(function(){return o.connect(e,n,t)}):(this.mWebSocketRTObject=new WebSocket(e+"?session="+encodeURIComponent(n)+"&client="+encodeURIComponent(t)),this.mWebSocketRTObject.binaryType="arraybuffer"),this.secretConfigKey=void 0,new Promise(function(i,r){o.mWebSocketRTObject.onopen=function(e){o.mSessionKey=n,o.mClientKey=t},o.mWebSocketRTObject.onmessage=function(n){if(n.data instanceof ArrayBuffer){var t=Utils.readMicroServiceHUBMessage(n.data),r=(t.version,t.sender,t.payload);o.secretConfigKey=Utils.arrayBufferToString(r)}else o.secretConfigKey=n.data;o.mWebSocketConfigObject=new WebSocket(e+"/config?secret_config_key="+encodeURIComponent(o.secretConfigKey)+"&session="+encodeURIComponent(o.mSessionKey)+"&client="+encodeURIComponent(o.mClientKey)),o.mWebSocketConfigObject.binaryType="arraybuffer",o.mWebSocketConfigObject.onopen=function(e){i({sessionKey:o.mSessionKey,myKey:o.mClientKey})},o.mWebSocketConfigObject.onerror=function(e){o.mWebSocketConfigObject=void 0},o.mWebSocketConfigObject.onmessage=function(e){var n="";if(e.data instanceof ArrayBuffer){var t=Utils.readMicroServiceHUBMessage(e.data),o=t.version,i=t.sender,r=t.payload;n=r}else n=e.data;document.dispatchEvent(new CustomEvent("microservicehub.config.message",{detail:{version:o,sender:i,message:n}}))},o.mWebSocketRTObject.onmessage=function(e){var n="";if(e.data instanceof ArrayBuffer){var t=Utils.readMicroServiceHUBMessage(e.data),o=t.version,i=t.sender,r=t.payload;n=r}else n=e.data;document.dispatchEvent(new CustomEvent("microservicehub.message",{detail:{version:o,sender:i,message:r}}))}},o.mWebSocketRTObject.onerror=function(e){o.mSessionKey=void 0,o.mClientKey=void 0,o.mWebSocketConfigObject=void 0,r(e)}})}},{key:"disconnect",value:function(){var e=this;this.mWebSocketRTObject&&this.mWebSocketRTObject.close(),this.mWebSocketConfigObject&&this.mWebSocketConfigObject.close();var n=new Promise(function(n,t){e.mWebSocketRTObject?e.mWebSocketRTObject.onclose=function(t){e.mWebSocketRTObject=void 0,n("RT session closed")}:n("RT session not opened")}),t=new Promise(function(n,t){e.mWebSocketConfigObject?e.mWebSocketConfigObject.onclose=function(t){e.mWebSocketConfigObject=void 0,n("Config session closed")}:n("Config session not opened")});return Promise.all([n,t])}},{key:"send",value:function(e){var n=this,t=arguments.length<=1||void 0===arguments[1]?"":arguments[1];return void 0!==this.mWebSocketRTObject&&this.mWebSocketRTObject.send(Utils.createMicroServiceHUBMessage(e,t)),new Promise(function(e,t){void 0===n.mWebSocketRTObject?t({message:"It is not connected!"}):e()})}},{key:"sendConfigMessage",value:function(e){var n=this;return void 0!==this.mWebSocketConfigObject&&this.mWebSocketConfigObject.send(Utils.createMicroServiceHUBMessage(e)),new Promise(function(e,t){void 0===n.mWebSocketConfigObject?t({message:"It is not connected!"}):e()})}}]),e}(),_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),Utils=function(){function Utils(){_classCallCheck(this,Utils)}return _createClass(Utils,null,[{key:"uuid",value:function e(){function n(){var e=4,n=Math.pow(16,e-1);return(Math.random()*(Math.pow(16,e)-n)+n|0).toString(16)}var e=[n()+n(),n(),n(),n(),n()+n()+n()];return e.join("-")}},{key:"execJavascript",value:function execJavascript(code){eval(code)}},{key:"arrayBufferToString",value:function(e){return String.fromCharCode.apply(null,new Uint8Array(e))}},{key:"stringToArrayBuffer",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?e.length:arguments[1];return function(){for(var t=new ArrayBuffer(n),o=new Uint8Array(t),i=0,r=e.length;i<r;i++)o[i]=e.charCodeAt(i);return t}()}},{key:"readMicroServiceHUBMessage",value:function(e){var n=20,t=2,o=22,i=[],r=void 0,c=new DataView(e);r=c.getUint16(0);for(var s=new DataView(e,t,n),a=0;a<s.byteLength&&0!=s.getUint8(a);a++)i[a]=String.fromCharCode(s.getUint8(a));var f=i.join(""),u=e.slice(o);return{version:r,sender:f,payload:u}}},{key:"createMicroServiceHUBMessage",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],t=1,o=2,i=20,r=2;n=n.substring(0,i);var c=new ArrayBuffer(o+i+e.byteLength),s=new DataView(c);s.setUint16(0,t);for(var a=new DataView(c,r,i),f=0;f<n.length;f++)a.setUint8(f,n.charCodeAt(f));for(var u=new DataView(e),l=new DataView(c,o+i),f=0;f<u.byteLength;f++)l.setUint8(f,u.getUint8(f));return c}}]),Utils}();